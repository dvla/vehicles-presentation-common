@(openingHour: Int, closingHour: Int, closingWarnPeriodMins: Int, dateService: uk.gov.dvla.vehicles.presentation.common.services.DateService)(implicit lang: Lang)

@import org.joda.time.DateTime
@import org.joda.time.DateTimeZone
@import org.joda.time.Period
@import org.joda.time.format.PeriodFormatterBuilder

@LondonTimeZone = @{DateTimeZone.forID("Europe/London")}

@periodFormatter = @{
    new PeriodFormatterBuilder().
    printZeroAlways().
    minimumPrintedDigits(2).
    appendHours().
    appendSeparator(":").
    appendMinutes().
    appendSeparator(".").
    appendSeconds().
    toFormatter
}

@currentTimeInLondon = @{dateService.now.toDateTime(LondonTimeZone)}

@closingTimeInLondonToday(closingHour: Int, currentTime: DateTime) = @{
    val closingTimeToday = currentTime.
    withHourOfDay(if (closingHour == 24) 0 else closingHour).
    withMinuteOfHour(0).
    withSecondOfMinute(0).
    withZone(LondonTimeZone)
    if (closingHour == 24) closingTimeToday.plusDays(1) else closingTimeToday
}

@timeUntilClosed(closingHour: Int) = @{
    val currentTime = currentTimeInLondon // The time is always moving forward, so measure it once and store in an immutable object.
    val closingTimeToday = closingTimeInLondonToday(closingHour, currentTime)
    val period = new Period(currentTime, closingTimeToday)
    period.toString(periodFormatter) // HH:mm.ss
}

@if(
    Some((closingHour, new org.joda.time.DateTime(
        dateService.now.toDateTime.getYear,
        dateService.now.toDateTime.getMonthOfYear,
        dateService.now.toDateTime.getDayOfMonth,
        if(closingHour == 24) 0 else closingHour,
        0, DateTimeZone.forID("Europe/London")
    ))).map { case (closingHour, closingTime) =>
        val closingT = if(closingHour == 24) closingTime.plusDays(1) else closingTime
        val warningTime = closingT.minusMinutes(closingWarnPeriodMins)
        val currentTime = new DateTime(dateService.now, DateTimeZone.forID("Europe/London"))
        currentTime.isAfter(warningTime) && currentTime.isBefore(closingT)
    }.get
) {

    @if(
        Some((closingHour, new org.joda.time.DateTime(
            dateService.now.toDateTime.getYear,
            dateService.now.toDateTime.getMonthOfYear,
            dateService.now.toDateTime.getDayOfMonth,
            if(closingHour == 24) 0 else closingHour,
            0, DateTimeZone.forID("Europe/London")
        ))).map { case (closingHour, closingTime) =>
            val closingT = if(closingHour == 24) closingTime.plusDays(1) else closingTime
            val warningTime = closingT.minusMinutes(5)
            val currentTime = new DateTime(dateService.now, DateTimeZone.forID("Europe/London"))
            currentTime.isAfter(warningTime) && currentTime.isBefore(closingT)
        }.get
    ) {
        @* 5 min warning *@
        <div class="serviceClosingWarning">
            <p>
                @Messages(
                    "global.serviceCloseWarning.fiveMinutes",
                    openingHour,
                    closingHour,
                    timeUntilClosed(closingHour)
                )
            </p>
        </div>
    } else {
        @* Normal service closing message *@
        <div class="serviceClosingWarning">
            <p>
            @Messages("global.serviceCloseWarning",
                new DateTime(dateService.now, DateTimeZone.forID("Europe/London")).toString(org.joda.time.format.DateTimeFormat.forPattern("HH:mm")),
                closingHour
            )
            </p>
        </div>
    }
}
